#!/bin/bash

SCRIPT_NAME=$(basename "$0")
TITLE="System Services"

showHelp() {
    echo "$DISTRO_NAME $TITLE"
    echo "Usage: $SCRIPT_NAME [OPTIONS]"
    echo "Options:"
    echo "  -t    Open in terminal"
    echo "  -e    Show Back instead of Exit"
    echo "  -h    Show this help"
}

openTerminal() {
    nohup flock -n $LOCK_DIR/$SCRIPT_NAME.lock terminal --columns=140 --lines=30 --title="$FLOATING_PREFIX $TITLE" $SCRIPT_NAME > /dev/null 2>&1 &
}

serviceMenu() {
    local service="$1"
    while true; do
        clear
        yprint -c --color=yellow "$DISTRO_NAME Service: $service"
        echo
        systemctl status "$service" 2>/dev/null | head -n 10
        echo
        
        # Check service state
        local is_active=$(systemctl is-active "$service" 2>/dev/null)
        local is_enabled=$(systemctl is-enabled "$service" 2>/dev/null)
        
        # Build menu based on state
        local options=""
        if [[ "$is_active" == "active" ]]; then
            options="  Stop Service\n  Restart Service\n"
        else
            options="  Start Service\n"
        fi
        
        if [[ "$is_enabled" == "enabled" ]]; then
            options="$options  Disable Service\n"
        else
            options="$options󱘖  Enable Service\n"
        fi
        
        options="$options󰌍  Back"
        
        height=$(($(tput lines) - 1))
        choice=$(echo -e "$options" | fzf \
            --layout=reverse \
            --prompt="Select action > " \
            --height=$height)
        
        [[ -z "$choice" ]] && break
        
        case "$choice" in
            *"Stop"*)
                sudo systemctl stop "$service"
                yprint --color=green "Service stopped!"
                sleep 1
                ;;
            *"Start"*)
                sudo systemctl start "$service"
                yprint --color=green "Service started!"
                sleep 1
                ;;
            *"Restart"*)
                sudo systemctl restart "$service"
                yprint --color=green "Service restarted!"
                sleep 1
                ;;
            *"Enable"*)
                sudo systemctl enable "$service"
                yprint --color=green "Service enabled!"
                sleep 1
                ;;
            *"Disable"*)
                sudo systemctl disable "$service"
                yprint --color=green "Service disabled!"
                sleep 1
                ;;
            *"Back"*) break ;;
        esac
    done
}

displayMenu() {
    while true; do
        clear
        yprint -c --color=yellow "$DISTRO_NAME $TITLE"
        
        # Get all services with colors
        local services=$(
        systemctl list-units --type=service --all --no-pager --no-legend \
        | awk '{print $1}' \
        | grep -E '(\.service$)' \
        | sort)
        
        # Color services based on state
        local colored_services=""
        while IFS= read -r service; do
            if systemctl is-active --quiet "$service" 2>/dev/null; then
                colored_services="$colored_services\e[32m$service\e[0m\n"
            else
                colored_services="$colored_services\e[31m$service\e[0m\n"
            fi
        done <<< "$services"
        
        height=$(($(tput lines) - 1))
        choice=$(echo -e "$colored_services$EXIT_TEXT" | fzf \
            --ansi \
            --layout=reverse \
            --prompt="Select service > " \
            --preview="systemctl status {} 2>/dev/null | head -n 200" \
            --preview-window=right:100 \
            --height=$height)
        
        # Strip color codes from choice
        choice=$(echo "$choice" | sed 's/\x1b\[[0-9;]*m//g')
        
        [[ -z "$choice" || "$choice" == "$EXIT_TEXT" ]] && exit 0
        
        serviceMenu "$choice"
    done
}

OPEN_TERMINAL=false
EXIT_TEXT="󰈆  Exit"

while getopts "teh" opt; do
    case $opt in
        t) OPEN_TERMINAL=true ;;
        e) EXIT_TEXT="󰌍  Back" ;;
        h) showHelp; exit 0 ;;
        \?) echo "Invalid option. Use -h for help."; exit 1 ;;
    esac
done

if [[ "$OPEN_TERMINAL" == true ]]; then
    openTerminal
    exit 0
fi

displayMenu
