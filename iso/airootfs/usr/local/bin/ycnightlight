#!/bin/bash

# __   __    _   _ _   _ ___  __
# \ \ / /__ | | | | \ | (_) \/ /
#  \ V / _ \| | | |  \| | |\  / 
#   | | (_) | |_| | |\  | |/  \ 
#   |_|\___/ \___/|_| \_|_/_/\_\
#
# License GPL3
# Homepage: https://github.com/apapamarkou/younix
# Author: Andrianos Papamarkou
# Email: papamarkoua@gmail.com

#
# YoUNiX Nightlight
#

SCRIPT_NAME=$(basename "$0")
TITLE="Nightlight"
CONFIG_DIR="$HOME/.config/nightlight"
CONFIG_FILE="$CONFIG_DIR/location.conf"
SERVICE_FILE="$HOME/.config/systemd/user/nightlight.service"

showHelp() {
    echo "$DISTRO_NAME $TITLE"
    echo "Usage: $SCRIPT_NAME [OPTIONS]"
    echo "Options:"
    echo "  -t    Open in terminal"
    echo "  -m    Output on/off status (for Waybar)"
    echo "  -s    Set nightlight on/off (on|off)"
    echo "  -h    Show this help"
}

openTerminal() {
    nohup flock -n ~/.config/lock terminal --columns=50 --lines=10 --title="$FLOATING_PREFIX $TITLE" $SCRIPT_NAME > /dev/null 2>&1 &
}

getLocation() {
    local force_update=${1:-false}
    
    if [[ "$force_update" == "false" && -f "$CONFIG_FILE" ]]; then
        source "$CONFIG_FILE"
        [[ -n "$LATITUDE" && -n "$LONGITUDE" ]] && return 0
    fi
    
    local lat=$(curl -s "https://ipapi.co/latitude/" 2>/dev/null)
    local lon=$(curl -s "https://ipapi.co/longitude/" 2>/dev/null)
    
    if [[ -n "$lat" && -n "$lon" ]]; then
        mkdir -p "$CONFIG_DIR"
        echo "LATITUDE=$lat" > "$CONFIG_FILE"
        echo "LONGITUDE=$lon" >> "$CONFIG_FILE"
        LATITUDE=$lat
        LONGITUDE=$lon
        return 0
    fi
    
    read -p "Enter latitude: " lat
    read -p "Enter longitude: " lon
    
    if [[ -n "$lat" && -n "$lon" ]]; then
        mkdir -p "$CONFIG_DIR"
        echo "LATITUDE=$lat" > "$CONFIG_FILE"
        echo "LONGITUDE=$lon" >> "$CONFIG_FILE"
        LATITUDE=$lat
        LONGITUDE=$lon
        return 0
    fi
    
    return 1
}

isEnabled() {
    systemctl --user is-enabled nightlight.service &>/dev/null
}

enableNightlight() {
    getLocation || { yprint --color=red "Failed to get location"; return 1; }
    
    mkdir -p "$(dirname "$SERVICE_FILE")"
    cat > "$SERVICE_FILE" << EOF
[Unit]
Description=Nightlight (wlsunset)
After=graphical-session.target

[Service]
Type=simple
ExecStart=/usr/bin/wlsunset -l $LATITUDE -L $LONGITUDE
Restart=on-failure

[Install]
WantedBy=graphical-session.target
EOF
    
    systemctl --user daemon-reload
    systemctl --user enable --now nightlight.service
    yprint --color=green "Nightlight enabled"
}

disableNightlight() {
    systemctl --user disable --now nightlight.service 2>/dev/null
    rm -f "$SERVICE_FILE"
    systemctl --user daemon-reload
    yprint --color=yellow "Nightlight disabled"
}

displayMenu() {
    while true; do
        clear
        yprint -c --color=yellow "$DISTRO_NAME $TITLE"
        
        local status_text="Nightlight is disabled"
        local action_text="  Enable nightlight"
        
        if isEnabled; then
            status_text="Nightlight is enabled"
            action_text="  Disable nightlight"
        fi
        
        yprint -c --color=green "$status_text"
        [[ -n "$LATITUDE" && -n "$LONGITUDE" ]] && yprint -c "Lat: $LATITUDE, Lon: $LONGITUDE"
        
        height=$(($(tput lines) - 3))
        choice=$(echo -e "$action_text\n  Update location\n$EXIT_TEXT" | fzf \
            --layout=reverse \
            --prompt="  > " \
            --height=$height)
        
        [[ -z "$choice" ]] && exit 0
        
        case "$choice" in
            *"Enable"*)
                enableNightlight
                read -p "Press Enter to continue..."
                ;;
            *"Disable"*)
                disableNightlight
                read -p "Press Enter to continue..."
                ;;
            *"Update location"*)
                getLocation true
                isEnabled && enableNightlight
                read -p "Press Enter to continue..."
                ;;
            *"$EXIT_TEXT"*)
                exit 0
                ;;
        esac
    done
}

OPEN_TERMINAL=false
WAYBAR_STATUS=false
SET_STATE=""
EXIT_TEXT="󰈆  Exit"

while getopts "etmhs:" opt; do
    case $opt in
        e) EXIT_TEXT="󰌍  Back" ;;
        t) OPEN_TERMINAL=true ;;
        m) WAYBAR_STATUS=true ;;
        s) SET_STATE="$OPTARG" ;;
        h) showHelp; exit 0 ;;
        \?) echo "Invalid option. Use -h for help."; exit 1 ;;
    esac
done

if [[ -n "$SET_STATE" ]]; then
    case "$SET_STATE" in
        on) enableNightlight ;;
        off) disableNightlight ;;
        *) echo "Invalid state. Use 'on' or 'off'."; exit 1 ;;
    esac
    exit 0
fi

if [[ "$WAYBAR_STATUS" == true ]]; then
    isEnabled && echo "󰛨" || echo "󰹏"
    exit 0
fi

if [[ "$OPEN_TERMINAL" == true ]]; then
    openTerminal
    exit 0
fi

getLocation
displayMenu
