#!/bin/bash

# __   __    _   _ _   _ ___  __
# \ \ / /__ | | | | \ | (_) \/ /
#  \ V / _ \| | | |  \| | |\  / 
#   | | (_) | |_| | |\  | |/  \ 
#   |_|\___/ \___/|_| \_|_/_/\_\
#
# License GPL3
# Homepage: https://github.com/apapamarkou/younix
# Author: Andrianos Papamarkou
# Email: papamarkoua@gmail.com

#
# YoUNiX Mount Utility
#

SCRIPT_NAME=$(basename "$0")
TITLE="Mount Utility"
CONFIG_DIR="$HOME/.config/ymount"
CONFIG_FILE="$CONFIG_DIR/mounts.conf"
AUTOMOUNT_FILE="$CONFIG_DIR/automount.conf"

showHelp() {
    echo "$DISTRO_NAME $TITLE"
    echo "Usage: $SCRIPT_NAME [OPTIONS]"
    echo "Options:"
    echo "  -a    Mount automount partitions and exit"
    echo "  -t    Open in terminal"
    echo "  -h    Show this help"
}

openTerminal() {
    nohup flock -n ~/.config/lock terminal --columns=80 --lines=20 --title="$FLOATING_PREFIX $TITLE" $SCRIPT_NAME > /dev/null 2>&1 &
}

loadConfig() {
    mkdir -p "$CONFIG_DIR"
    [[ -f "$CONFIG_FILE" ]] && source "$CONFIG_FILE"
}

saveMount() {
    local partition="$1"
    local folder_name="$2"
    local partition_name=$(basename "$partition")
    
    mkdir -p "$CONFIG_DIR"
    
    # Remove existing entry if present
    [[ -f "$CONFIG_FILE" ]] && sed -i "/^$partition_name=/d" "$CONFIG_FILE"
    
    # Add new entry
    echo "$partition_name=$folder_name" >> "$CONFIG_FILE"
}

getMountFolder() {
    local partition="$1"
    local partition_name=$(basename "$partition")
    
    [[ -f "$CONFIG_FILE" ]] && grep "^$partition_name=" "$CONFIG_FILE" | cut -d'=' -f2
}

isAutomount() {
    local partition="$1"
    local partition_name=$(basename "$partition")
    [[ -f "$AUTOMOUNT_FILE" ]] && grep -q "^$partition_name$" "$AUTOMOUNT_FILE"
}

toggleAutomount() {
    local partition="$1"
    local partition_name=$(basename "$partition")
    mkdir -p "$CONFIG_DIR"
    
    if isAutomount "$partition"; then
        sed -i "/^$partition_name$/d" "$AUTOMOUNT_FILE"
        yprint --color=yellow "Automount disabled for $partition"
    else
        echo "$partition_name" >> "$AUTOMOUNT_FILE"
        yprint --color=green "Automount enabled for $partition"
    fi
    read -p "Press Enter to continue..."
}

getPartitionInfo() {
    local partition="$1"
    [[ "$partition" =~ (Back|Exit) ]] && return
    
    local drive=$(echo "$partition" | sed 's/[0-9]*$//')
    local size=$(lsblk -dno SIZE "$partition" 2>/dev/null || echo "Unknown")
    local mountpoint=$(findmnt -n -o TARGET "$partition" 2>/dev/null)
    local used_space="N/A"
    local free_space="N/A"
    local config_folder=$(getMountFolder "$partition")
    
    if [[ -n "$mountpoint" ]]; then
        local df_info=$(df -h "$partition" 2>/dev/null | tail -1)
        used_space=$(echo "$df_info" | awk '{print $3}')
        free_space=$(echo "$df_info" | awk '{print $4}')
    else
        mountpoint="<not mounted>"
    fi
    
    echo "Drive: $drive"
    echo "Partition: $partition"
    echo "Size: $size"
    echo "Used space: $used_space"
    echo "Free space: $free_space"
    echo ""
    echo "Mount point: $mountpoint"
    [[ -n "$config_folder" ]] && echo "Config folder: $config_folder"
    isAutomount "$partition" && echo "Automount: enabled" || echo "Automount: disabled"
}

setMountPoint() {
    local partition="$1"
    local current_folder=$(getMountFolder "$partition")
    local label=$(lsblk -no LABEL "$partition" 2>/dev/null)
    local default_name=$(basename "$partition")
    
    [[ -n "$label" ]] && default_name="$label"
    [[ -n "$current_folder" ]] && default_name="$current_folder"
    
    read -e -p "Enter folder name: " -i "$default_name" folder_name
    [[ -n "$folder_name" ]] && {
        saveMount "$partition" "$folder_name"
        yprint --color=green "Mount folder set to: $HOME/Drives/$folder_name"
        read -p "Press Enter to continue..."
    }
}

mountPartition() {
    local partition="$1"
    local current_mount=$(lsblk -no MOUNTPOINT "$partition" 2>/dev/null)
    
    if [[ -n "$current_mount" ]]; then
        yprint --color=yellow "Unmounting $partition from $current_mount..."
        sudo umount "$partition"
        if [[ $? -eq 0 ]]; then
            yprint --color=green "Successfully unmounted!"
        else
            yprint --color=red "Failed to unmount!"
        fi
    else
        local folder_name=$(getMountFolder "$partition")
        
        if [[ -z "$folder_name" ]]; then
            yprint --color=red "No mount folder configured. Set mount point first."
            read -p "Press Enter to continue..."
            return
        fi
        
        local mount_path="$HOME/Drives/$folder_name"
        mkdir -p "$mount_path"
        
        yprint --color=yellow "Mounting $partition to $mount_path..."
        sudo mount "$partition" "$mount_path"
        if [[ $? -eq 0 ]]; then
            sudo chown $USER:$USER "$mount_path"
            yprint --color=green "Successfully mounted!"
        else
            yprint --color=red "Failed to mount!"
        fi
    fi
    
    read -p "Press Enter to continue..."
}

partitionMenu() {
    local partition="$1"
    
    while true; do
        clear
        yprint -c --color=yellow "Partition: $partition"
        
        local current_mount=$(lsblk -no MOUNTPOINT "$partition" 2>/dev/null)
        local mount_text="  Mount"
        local point_text="  Set mount point"
        
        if [[ -n "$current_mount" ]]; then
            mount_text="  Unmount"
            point_text="  Change mount point"
        fi
        
        choice=$(echo -e "$point_text\n$mount_text\n󰌍  Back" | fzf \
            --layout=reverse \
            --prompt=" Select > " \
            --height=50% \
            --preview="$0 --info '$partition'" \
            --preview-window=right:60%:wrap)
        
        [[ -z "$choice" ]] && break
        
        case "$choice" in
            *"mount point"*) setMountPoint "$partition" ;;
            *"Mount"*|*"Unmount"*) mountPartition "$partition" ;;
            *"Back"*) break ;;
        esac
    done
}

displayMenu() {
    loadConfig
    
    while true; do
        clear
        yprint -c --color=yellow "$DISTRO_NAME $TITLE"
        
        # Get all partitions (excluding loop devices and system partitions)
        local partitions=$(lsblk -rno NAME,TYPE | awk '$2=="part" {print "/dev/" $1}' | grep -vE '(loop|sr[0-9]|ram[0-9])' | sort)
        local options=$(echo -e "$partitions\n$EXIT_TEXT")
        
        height=$(($(tput lines) - 1))
        
        choice=$(echo "$options" | fzf \
            --layout=reverse \
            --prompt="  Select partition > " \
            --height=$height \
            --preview="$0 --info {}" \
            --preview-window=right:60%:wrap)
        
        [[ -z "$choice" ]] && exit 0
        
        case "$choice" in
            *"$EXIT_TEXT"*) exit 0 ;;
            /dev/*) partitionMenu "$choice" ;;
        esac
    done
}



# Handle --info parameter for fzf preview
if [[ "$1" == "--info" ]]; then
    getPartitionInfo "$2"
    exit 0
fi

OPEN_TERMINAL=false
EXIT_TEXT="󰈆  Exit"

while getopts "eth" opt; do
    case $opt in
        e) EXIT_TEXT="󰌍  Back" ;;
        t) OPEN_TERMINAL=true ;;
        h) showHelp; exit 0 ;;
        \?) echo "Invalid option. Use -h for help."; exit 1 ;;
    esac
done

if [[ "$OPEN_TERMINAL" == true ]]; then
    openTerminal
    exit 0
fi

displayMenu