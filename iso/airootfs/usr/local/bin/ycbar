#!/bin/bash

# YoUNiX Waybar Module Toggle Script
MUTE_NOTIFY=false
MUTE_ECHO=false
SCRIPT_NAME=$(basename "$0")
TITLE="Waybar Modules"

CONFIG_FILE="$HOME/.config/waybar/config.jsonc"

showHelp() {
    echo "$DISTRO_NAME $TITLE"
    echo "Usage: $SCRIPT_NAME [OPTIONS]"
    echo "Options:"
    echo "  -t    Open in terminal"
    echo "  -h    Show this help"
    exit 0
}

openTerminal() {
    echo "opening terminal"
    nohup flock -n $LOCK_DIR/$SCRIPT_NAME.lock terminal --columns=50 --lines=20 --title="$FLOATING_PREFIX $TITLE" $SCRIPT_NAME $args > /dev/null 2>&1 &
}

printMessage() {
    if [ "$MUTE_NOTIFY" = false ]; then
        notify-send "$@"
    fi
    if [ "$MUTE_ECHO" = false ]; then
        echo -e "$@"
    fi
}

get_available_modules() {
    jq -r '."modules-right"[]?' "$CONFIG_FILE"
}

get_all_modules() {
    # All real modules = top-level keys whose value is an object
    # Exclude structural keys (modules-left/center/right, layer, position, etc.)
    jq -r 'to_entries[] | select(.value | type == "object") | .key' "$CONFIG_FILE" |
    grep -v -E '^(modules-left|modules-center|modules-right|layer|position|height|spacing|custom/launcher|custom/modes|hyprland/workspaces)$'
}

is_enabled() {
    jq -r '."modules-right"[]' "$CONFIG_FILE" | grep -qx "$1"
}

reloadWaybar() {
    killall waybar
    nohup waybar > /dev/null 2>&1 &
}

enable_module() {
    tmp=$(mktemp)
    jq ".\"modules-right\" += [\"$1\"]" "$CONFIG_FILE" > "$tmp" && mv "$tmp" "$CONFIG_FILE"
    reloadWaybar
}

disable_module() {
    tmp=$(mktemp)
    jq ".\"modules-right\" |= map(select(. != \"$1\"))" "$CONFIG_FILE" > "$tmp" && mv "$tmp" "$CONFIG_FILE"
    reloadWaybar
}

move_left() {
    tmp=$(mktemp)
    # The variable $1 is the module name passed to the function
    # Corrected jq expression:
    jq ".\"modules-right\" |= (
        # Find the index of the module name ($1) and assign it to $idx
        (index(\"$1\")) as \$idx | 
        # Check if the index is greater than 0 (i.e., not the first element)
        if \$idx > 0 then 
            # Reorder:
            # .[:\$idx-1]     -> All elements before the target's left neighbor
            # + [.[ \$idx ]]   -> The target module
            # + [.[ \$idx-1 ]] -> The target's left neighbor
            # + .[\$idx+1:]    -> All elements after the target
            .[:\$idx-1] + [.[ \$idx ]] + [.[ \$idx-1 ]] + .[\$idx+1:]
        else
            # If it's the first element (index 0), do nothing
            .
        end
    )" "$CONFIG_FILE" > "$tmp" && mv "$tmp" "$CONFIG_FILE"
    reloadWaybar
}

move_right() {
    tmp=$(mktemp)
    total=$(jq '."modules-right" | length' "$CONFIG_FILE")
    
    # The variable $1 is the module name passed to the function
    jq ".\"modules-right\" |= (
        # Find the index of the module name ($1) and assign it to $idx
        (index(\"$1\")) as \$idx | 
        
        # Check if the index is less than the total length minus 1 
        # (i.e., not the last element)
        if \$idx < $total - 1 then
            # Reorder (swaps element at \$idx with element at \$idx+1):
            # .[:\$idx]     -> All elements before the target
            # + [.[ \$idx+1 ]] -> The target's right neighbor (moves left)
            # + [.[ \$idx ]]   -> The target module (moves right)
            # + .[\$idx+2:]    -> All elements after the right neighbor
            .[:\$idx] + [.[ \$idx+1 ]] + [.[ \$idx ]] + .[\$idx+2:]
        else
            # If it's the last element, do nothing
            .
        end
    )" "$CONFIG_FILE" > "$tmp" && mv "$tmp" "$CONFIG_FILE"
    reloadWaybar
}

module_menu() {
    local mod="$1"
    while true; do
        yprint -c --color=yellow "$DISTRO_NAME $TITLE"
        yprint -c --color=green "Configure module $mod"
        height=$(($(tput lines) - 2))
        choice=$(printf "  Disable %s\n  Move left\n  Move right\n󰌍  Back" "$mod" | fzf  --height=$height --ansi --layout=reverse --prompt="  > ")
        case "$choice" in
            *"Disable"*) 
                disable_module "$mod"
                return 
            ;;
            *"Move left"*) move_left "$mod" ;;
            *"Move right"*) move_right "$mod" ;;
            *) return ;;
        esac
    done
}

displayMenu() {
    while true; do
        all=$(get_all_modules)
        enabled=$(get_available_modules) # This contains modules currently in modules-right

        enabled_list=""
        disabled_list=""

        for m in $all; do
            # Check if module 'm' is present in the list of 'enabled' modules
            if echo "$enabled" | grep -qx "$m"; then
                enabled_list+="Configure $m
"
            else
                disabled_list+="Enable $m
"
            fi
        done

        # Combine the lists: Enabled modules first, then Disabled modules
        menu_list="$enabled_list$disabled_list"

        yprint -c --color=yellow "$DISTRO_NAME $TITLE"
        height=$(($(tput lines) - 1))
        
        # Pass the combined list to fzf
        choice=$(echo -e "$menu_list$EXIT_TEXT" | fzf --ansi --layout=reverse --prompt="  > " --height=$height)

        case "$choice" in
            "Enable"*)
                module="${choice#Enable }"
                enable_module "$module"
                ;;
            "Configure"*)
                module="${choice#Configure }"
                module_menu "$module"
                ;;
            *) exit 0 ;;
        esac
    done
}

OPEN_TERMINAL=false
EXIT_TEXT="󰈆  Exit"

while getopts "the" opt; do
    case $opt in
        e) EXIT_TEXT="󰌍  Back" ;;
        t) OPEN_TERMINAL=true ;;
        h) showHelp ;;
        *) exit 1 ;;
    esac
done

if [ "$OPEN_TERMINAL" = true ]; then
    openTerminal
    exit 0
fi

displayMenu
