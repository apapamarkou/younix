#!/bin/bash

# Standard YoUNiX Control script template
MUTE_NOTIFY=false
MUTE_ECHO=false
SCRIPT_NAME=$(basename "$0")
TITLE="Power Management"
CONF="$HOME/.config/hypr/hypridle.conf"

showHelp() {
    echo "$DISTRO_NAME $TITLE"
    echo "Usage: $SCRIPT_NAME [OPTIONS]"
    echo "Options:"
    echo "  -t    Open in terminal"
    echo "  -h    Show this help"
    echo "Arguments can be combined: -vn, -nv, etc."
    exit 0
}

openTerminal() {
    nohup flock -n $LOCK_DIR/$SCRIPT_NAME.lock terminal --columns=50 --lines=15 --title="$FLOATING_PREFIX $TITLE" $SCRIPT_NAME $args > /dev/null 2>&1 &
}

printMessage() {
    if [ "$MUTE_NOTIFY" = false ]; then
        notify-send "$@"
    fi
    if [ "$MUTE_ECHO" = false ]; then
        echo -e "$@"
    fi
}

get_current_values() {
    if [ -f "$CONF" ]; then
        lock_timeout=$(grep -A2 "# Listener 1" "$CONF" | grep "timeout" | grep -o '[0-9]*' | head -1)
        screen_timeout=$(grep -A3 "# Listener 2" "$CONF" | grep "timeout" | grep -o '[0-9]*' | head -1)
        suspend_timeout=$(grep -A3 "# Listener 3" "$CONF" | grep "timeout" | grep -o '[0-9]*' | head -1)
        
        [ -n "$lock_timeout" ] && lock_mins=$((lock_timeout / 60)) || lock_mins=5
        [ -n "$screen_timeout" ] && screen_mins=$((screen_timeout / 60)) || screen_mins=6
        [ -n "$suspend_timeout" ] && suspend_mins=$((suspend_timeout / 60)) || suspend_mins=10
    else
        lock_mins=5
        screen_mins=6
        suspend_mins=10
    fi
}

enable_now() {
    pkill hypridle 2>/dev/null;
    hyprctl dispatch exec "hypridle" 2>/dev/null
}

update_lock_timeout() {
    local mins="$1"
    local timeout=$((mins == "never" ? 999999 : mins * 60))
    sed -i '/# Listener 1/,/^}/ s/^[[:space:]]*timeout = [0-9]*/    timeout = '$timeout'/' "$CONF"
    enable_now 
}

update_screen_timeout() {
    local mins="$1"
    local timeout=$((mins == "never" ? 999999 : mins * 60))
    sed -i '/# Listener 2/,/^}/ s/^[[:space:]]*timeout = [0-9]*/    timeout = '$timeout'/' "$CONF"
    enable_now 
}

update_suspend_timeout() {
    local mins="$1"
    local timeout=$((mins == "never" ? 999999 : mins * 60))
    sed -i '/# Listener 3/,/^}/ s/^[[:space:]]*timeout = [0-9]*/    timeout = '$timeout'/' "$CONF"
    enable_now 
}

show_lock_menu() {
    while true; do
        clear
        yprint -c --color=yellow "$DISTRO_NAME Lock Screen Timeout"
        height=$(($(tput lines) - 1))
        choice=$(echo -e "   2 mins\n   5 mins\n   10 mins\n   30 mins\n   Never\n󰌍  Back" | fzf \
                --ansi \
                --layout=reverse \
                --prompt="  > " \
                --height=$height)
        case "$choice" in
            *"2 mins"*) update_lock_timeout 2; return ;;
            *"5 mins"*) update_lock_timeout 5; return ;;
            *"10 mins"*) update_lock_timeout 10; return ;;
            *"30 mins"*) update_lock_timeout 30; return ;;
            *"Never"*) update_lock_timeout never; return ;;
            *) return ;;
        esac
    done
}

show_screen_menu() {
    while true; do
        clear
        yprint -c --color=yellow "$DISTRO_NAME Screen Off Timeout"
        height=$(($(tput lines) - 1))
        choice=$(echo -e "   5 mins\n   7 mins\n   17 mins\n   35 mins\n   Never\n󰌍  Back" | fzf \
                --ansi \
                --layout=reverse \
                --prompt="  > " \
                --height=$height)
        case "$choice" in
            *"5 mins"*) update_screen_timeout 5; return ;;
            *"7 mins"*) update_screen_timeout 7; return ;;
            *"17 mins"*) update_screen_timeout 17; return ;;
            *"35 mins"*) update_screen_timeout 35; return ;;
            *"Never"*) update_screen_timeout never; return ;;
            *) return ;;
        esac
    done
}

show_suspend_menu() {
    while true; do
        clear
        yprint -c --color=yellow "$DISTRO_NAME Suspend Timeout"
        height=$(($(tput lines) - 1))
        choice=$(echo -e "   7 mins\n   10 mins\n   20 mins\n   40 mins\n   Never\n󰌍  Back" | fzf \
                --ansi \
                --layout=reverse \
                --prompt="  > " \
                --height=$height)
        case "$choice" in
            *"7 mins"*) update_suspend_timeout 7; return ;;
            *"10 mins"*) update_suspend_timeout 10; return ;;
            *"20 mins"*) update_suspend_timeout 20; return ;;
            *"40 mins"*) update_suspend_timeout 40; return ;;
            *"Never"*) update_suspend_timeout never; return ;;
            *) return ;;
        esac
    done
}

displayMenu() {
    while true; do
        clear
        yprint -c --color=yellow "$DISTRO_NAME $TITLE"
        get_current_values
        
        lock_text="Lock Screen After ${lock_mins} mins"
        screen_text="Turn off screen ${screen_mins} mins"
        suspend_text="Suspend system after ${suspend_mins} mins"
        
        height=$(($(tput lines) - 1))
        choice=$(echo -e "  $lock_text\n󰍹  $screen_text\n󰒲  $suspend_text\n$EXIT_TEXT" | fzf \
                --ansi \
                --layout=reverse \
                --prompt="  > " \
                --height=$height)
        case "$choice" in
                *"Lock Screen"*) show_lock_menu ;;
                *"Turn off"*) show_screen_menu ;;
                *"Suspend"*) show_suspend_menu ;;
                *) exit 0 ;;
        esac
    done
}

OPEN_TERMINAL=false
EXIT_TEXT="󰈆  Exit"

while getopts "the" opt; do
    case $opt in
        e) EXIT_TEXT="󰌍  Back" ;;
        t) OPEN_TERMINAL=true ;;
        h) showHelp ;;
        \?) echo "Invalid option. Use -h for help."; exit 1 ;;
    esac
done

if [ "$OPEN_TERMINAL" = true ]; then
    openTerminal
    exit 0
fi

displayMenu