#!/bin/bash

# __   __    _   _ _   _ ___  __
# \ \ / /__ | | | | \ | (_) \/ /
#  \ V / _ \| | | |  \| | |\  / 
#   | | (_) | |_| | |\  | |/  \ 
#   |_|\___/ \___/|_| \_|_/_/\_\
#
# License GPL3
# Homepage: https://github.com/apapamarkou/younix
# Author: Andrianos Papamarkou
# Email: papamarkoua@gmail.com

#
# YoUNiX Home Backup
#

SCRIPT_NAME=$(basename "$0")
TITLE="Home Backup"
BASE_FOLDER_NAME="ybackup"
CONFIG_DIR="$HOME/.config/$BASE_FOLDER_NAME"
CONFIG_FILE="$CONFIG_DIR/config"
EXCLUDE_FILE="$CONFIG_DIR/excludes"

# Default values
DESTINATION=""
HOURLY_ENABLED=false
DAILY_ENABLED=false
WEEKLY_ENABLED=false
MONTHLY_ENABLED=false
HOURLY_KEEP=7
DAILY_KEEP=7
WEEKLY_KEEP=4
MONTHLY_KEEP=12

showHelp() {
    echo "$DISTRO_NAME $TITLE"
    echo "Usage: $SCRIPT_NAME [OPTIONS]"
    echo "Options:"
    echo "  -t    Open in terminal"
    echo "  -b    Create backup snapshot"
    echo "  -n    Backup name (hourly/daily/monthly)"
    echo "  -h    Show this help"
}

openTerminal() {
    nohup flock -n $LOCK_DIR/$SCRIPT_NAME.lock terminal --columns=80 --lines=24 --title="$FLOATING_PREFIX $TITLE" $SCRIPT_NAME > /dev/null 2>&1 &
}

loadConfig() {
    mkdir -p "$CONFIG_DIR"
    [[ -f "$CONFIG_FILE" ]] && source "$CONFIG_FILE"
    
    # Initialize excludes with dotfiles and Drives by default
    if [[ ! -f "$EXCLUDE_FILE" ]]; then
        {
            ls -1a "$HOME" | grep '^\.' | grep -v '^\.\.?$'
            echo "Drives"
        } > "$EXCLUDE_FILE"
    fi
}

saveConfig() {
    cat > "$CONFIG_FILE" << EOF
DESTINATION="$DESTINATION"
HOURLY_ENABLED=$HOURLY_ENABLED
DAILY_ENABLED=$DAILY_ENABLED
WEEKLY_ENABLED=$WEEKLY_ENABLED
MONTHLY_ENABLED=$MONTHLY_ENABLED
HOURLY_KEEP=$HOURLY_KEEP
DAILY_KEEP=$DAILY_KEEP
WEEKLY_KEEP=$WEEKLY_KEEP
MONTHLY_KEEP=$MONTHLY_KEEP
EOF
}

selectDestination() {
    height=$(($(tput lines) - 1))
    local choice=$(echo -e "  Browse for folder\n  Enter path manually\n󰌍  Back" | fzf --layout=reverse --prompt="Select destination method > " --height=$height)
    
    case "$choice" in
        *"Browse"*)
            DESTINATION=$(find /mnt /media /home -maxdepth 3 -type d 2>/dev/null | fzf --layout=reverse --prompt="Select backup destination > " --height=$height)
            ;;
        *"Enter path"*)
            read -e -p "Enter backup destination path: " DESTINATION
            ;;
        *) 
            return
            ;;
    esac
    
    [[ -n "$DESTINATION" ]] && {
        mkdir -p "$DESTINATION/$BASE_FOLDER_NAME"
        DESTINATION="$DESTINATION/$BASE_FOLDER_NAME"
        saveConfig
        yprint --color=green "Destination set to: $DESTINATION"
        sleep 2
    }
}

createSnapshot() {
    local backup_name="$1"
    local interactive="$2"
    
    [[ "$interactive" == "true" ]] && clear
    [[ -z "$DESTINATION" ]] && { yprint --color=red "No destination selected"; [[ "$interactive" == "true" ]] && read -p "Press Enter..."; return; }
    
    local timestamp=$(date +%Y%m%d_%H%M%S)
    local snapshot_name="$timestamp-home-backup-snapshot"
    [[ -n "$backup_name" ]] && snapshot_name="$timestamp-$backup_name-home-backup-snapshot"
    local snapshot_path="$DESTINATION/$snapshot_name"
    
    yprint --color=yellow "Creating snapshot: $snapshot_name"
    [[ "$interactive" == "true" ]] && echo
    
    # Build exclude options
    local exclude_opts=""
    while IFS= read -r exclude; do
        exclude_opts="$exclude_opts --exclude=$exclude"
    done < "$EXCLUDE_FILE"
    
    # Build rsync command
    local rsync_cmd="rsync -avH --delete $exclude_opts"
    [[ "$interactive" != "true" ]] && rsync_cmd="$rsync_cmd --quiet"
    rsync_cmd="$rsync_cmd $HOME/ $snapshot_path/"
    
    if [[ "$interactive" == "true" ]]; then
        eval $rsync_cmd
    else
        eval $rsync_cmd
    fi
    
    local exit_code=$?
    
    if [[ $exit_code -eq 0 ]]; then
        yprint --color=green "  Snapshot created successfully!"
        notify-send "Backup created" \
            "Snapshot $snapshot_name created successfully at $DESTINATION."
        
        # Clean old backups based on retention policy
        [[ -n "$backup_name" ]] && cleanOldBackups "$backup_name"
    else
        yprint --color=red "󰬅  Snapshot creation failed!"
        notify-send -u critical "Backup failed" \
            "Failed to create snapshot $snapshot_name. Check logs for details."
    fi
    
    [[ "$interactive" == "true" ]] && read -p "Press Enter to continue..."
}

toggleExclude() {
    local item="$1"
    if grep -q "^$item$" "$EXCLUDE_FILE"; then
        sed -i "/^$item$/d" "$EXCLUDE_FILE"
    else
        echo "$item" >> "$EXCLUDE_FILE"
    fi
}

manageExcludes() {
    while true; do
        clear
        yprint -c --color=yellow "$DISTRO_NAME $TITLE Exclude Items"
        
        local options=""
        # Show folders first, then files, then dotfiles (exclude Drives)
        for item in $(ls -1a "$HOME" | grep -v '^\.$' | grep -v '^\.\..$' | grep -v '^\.' | grep -v '^Drives$' | sort); do
            if [[ -d "$HOME/$item" ]]; then
                if grep -q "^$item$" "$EXCLUDE_FILE"; then
                    options="$options[ ]  $item\n"
                else
                    options="$options[I]  $item\n"
                fi
            fi
        done
        for item in $(ls -1a "$HOME" | grep -v '^\.$' | grep -v '^\.\..$' | grep -v '^\.' | grep -v '^Drives$' | sort); do
            if [[ -f "$HOME/$item" ]]; then
                if grep -q "^$item$" "$EXCLUDE_FILE"; then
                    options="$options[ ]   $item\n"
                else
                    options="$options[I]   $item\n"
                fi
            fi
        done
        for item in $(ls -1a "$HOME" | grep -v '^\.$' | grep -v '^\..$' | grep '^\.' | sort); do
            if grep -q "^$item$" "$EXCLUDE_FILE"; then
                if [[ -d "$HOME/$item" ]]; then
                    options="$options[ ]  $item\n"
                else
                    options="$options[ ]   $item\n"
                fi
            else
                if [[ -d "$HOME/$item" ]]; then
                    options="$options[I]  $item\n"
                else
                    options="$options[I]   $item\n"
                fi
            fi
        done
        options="$options󰌍  Back"
        
        height=$(($(tput lines) - 1))
        choice=$(echo -e "$options" | fzf \
            --layout=reverse \
            --prompt="Toggle excludes ([I] is included) > " \
            --height=$height)
        
        [[ -z "$choice" || "$choice" =~ "Back" ]] && break
        
        local item="${choice:6}"
        toggleExclude "$item"
    done
}

createSystemdFiles() {
    local name="$1"
    local service_file="/etc/systemd/system/ybackup-$name.service"
    local timer_file="/etc/systemd/system/ybackup-$name.timer"
    
    sudo tee "$service_file" > /dev/null << EOF
[Unit]
Description=YoUNiX Home Backup $name
Wants=ybackup-$name.timer

[Service]
Type=oneshot
ExecStart=/home/user/.local/bin/ybackup -b -n $name
User=$USER

[Install]
WantedBy=multi-user.target
EOF
    
    local schedule
    case "$name" in
        "hourly") schedule="hourly" ;;
        "daily") schedule="daily" ;;
        "weekly") schedule="weekly" ;;
        "monthly") schedule="monthly" ;;
    esac
    
    sudo tee "$timer_file" > /dev/null << EOF
[Unit]
Description=YoUNiX Home Backup $name Timer
Requires=ybackup-$name.service

[Timer]
OnCalendar=$schedule
Persistent=true

[Install]
WantedBy=timers.target
EOF
    
    sudo systemctl daemon-reload
    sudo systemctl enable "ybackup-$name.timer"
    sudo systemctl start "ybackup-$name.timer"
}

toggleHourly() {
    if [[ "$HOURLY_ENABLED" == true ]]; then
        HOURLY_ENABLED=false
        sudo systemctl stop ybackup-hourly.timer
        sudo systemctl disable ybackup-hourly.timer
    else
        HOURLY_ENABLED=true
        createSystemdFiles "hourly"
    fi
    saveConfig
}

toggleDaily() {
    if [[ "$DAILY_ENABLED" == true ]]; then
        DAILY_ENABLED=false
        sudo systemctl stop ybackup-daily.timer
        sudo systemctl disable ybackup-daily.timer
    else
        DAILY_ENABLED=true
        createSystemdFiles "daily"
    fi
    saveConfig
}

toggleWeekly() {
    if [[ "$WEEKLY_ENABLED" == true ]]; then
        WEEKLY_ENABLED=false
        sudo systemctl stop ybackup-weekly.timer
        sudo systemctl disable ybackup-weekly.timer
    else
        WEEKLY_ENABLED=true
        createSystemdFiles "weekly"
    fi
    saveConfig
}

toggleMonthly() {
    if [[ "$MONTHLY_ENABLED" == true ]]; then
        MONTHLY_ENABLED=false
        sudo systemctl stop ybackup-monthly.timer
        sudo systemctl disable ybackup-monthly.timer
    else
        MONTHLY_ENABLED=true
        createSystemdFiles "monthly"
    fi
    saveConfig
}

setHourlyKeep() {
    height=$(($(tput lines) - 1))
    local count=$(seq 1 24 | fzf --layout=reverse --prompt="Keep last N hourly backups > " --height=$height)
    [[ -n "$count" ]] && {
        HOURLY_KEEP=$count
        saveConfig
    }
}

setDailyKeep() {
    height=$(($(tput lines) - 1))
    local count=$(seq 1 7 | fzf --layout=reverse --prompt="Keep last N daily backups > " --height=$height)
    [[ -n "$count" ]] && {
        DAILY_KEEP=$count
        saveConfig
    }
}

setWeeklyKeep() {
    height=$(($(tput lines) - 1))
    local count=$(seq 1 4 | fzf --layout=reverse --prompt="Keep last N weekly backups > " --height=$height)
    [[ -n "$count" ]] && {
        WEEKLY_KEEP=$count
        saveConfig
    }
}

setMonthlyKeep() {
    height=$(($(tput lines) - 1))
    local count=$(seq 1 12 | fzf --layout=reverse --prompt="Keep last N monthly backups > " --height=$height)
    [[ -n "$count" ]] && {
        MONTHLY_KEEP=$count
        saveConfig
    }
}

cleanOldBackups() {
    local backup_type="$1"
    local keep_count
    
    case "$backup_type" in
        "hourly") keep_count=$HOURLY_KEEP ;;
        "daily") keep_count=$DAILY_KEEP ;;
        "weekly") keep_count=$WEEKLY_KEEP ;;
        "monthly") keep_count=$MONTHLY_KEEP ;;
        *) return ;;
    esac
    
    # Get list of backups for this type, sorted by date (newest first)
    local backups=$(ls -1t "$DESTINATION"/ 2>/dev/null | grep "$backup_type-home-backup-snapshot")
    local count=$(echo "$backups" | wc -l)
    
    # Delete old backups if count exceeds keep_count
    if [[ $count -gt $keep_count ]]; then
        echo "$backups" | tail -n +$((keep_count + 1)) | while read -r old_backup; do
            rm -rf "$DESTINATION/$old_backup"
        done
    fi
}

deleteSnapshot() {
    local snapshot="$1"
    height=$(($(tput lines) - 1))
    local choice=$(echo -e "󰆴  Delete\n󰬅  Cancel" | fzf --layout=reverse --prompt="Delete $snapshot? " --height=$height)
    
    [[ "$choice" =~ "Delete" ]] && {
        rm -rf "$DESTINATION/$snapshot" 2>/dev/null
        yprint --color=green "Snapshot deleted!"
        read -p "Press Enter to continue..."
    }
}

snapshotMenu() {
    local snapshot="$1"
    while true; do
        [[ ! -d "$DESTINATION/$snapshot" ]] && return
        clear
        yprint -c --color=yellow "Snapshot: $snapshot"
        height=$(($(tput lines) - 1))
        choice=$(echo -e "󰆴  Delete Snapshot\n󰌍  Back to Main Menu" | fzf \
            --layout=reverse \
            --prompt="  Select action > " \
            --height=$height)
        
        [[ -z "$choice" ]] && break
        
        case "$choice" in
            *"Delete"*) deleteSnapshot "$snapshot" ;;
            *"Back"*) break ;;
        esac
    done
}

displayMenu() {
    loadConfig
    
    while true; do
        clear
        yprint -c --color=yellow "$DISTRO_NAME $TITLE"
        
        # Build dynamic menu
        local dest_text="  Select Destination first!"
        [[ -n "$DESTINATION" ]] && dest_text="  Change Destination ($DESTINATION)"
        
        local hourly_text="  Enable Hourly Backups"
        [[ "$HOURLY_ENABLED" == true ]] && hourly_text="  Disable Hourly Backups"
        
        local daily_text="  Enable Daily Backups"
        [[ "$DAILY_ENABLED" == true ]] && daily_text="  Disable Daily Backups"
        
        local weekly_text="  Enable Weekly Backups"
        [[ "$WEEKLY_ENABLED" == true ]] && weekly_text="  Disable Weekly Backups"
        
        local monthly_text="  Enable Monthly Backups"
        [[ "$MONTHLY_ENABLED" == true ]] && monthly_text="  Disable Monthly Backups"
        
        # Build options
        local options="$dest_text\n󰈆  Exit"
        
        if [[ -n "$DESTINATION" ]]; then
            options="󰄀  Create Snapshot\n$dest_text\n  Manage Excludes\n$hourly_text"
            [[ "$HOURLY_ENABLED" == true ]] && options="$options\n󰮆  Keep Last $HOURLY_KEEP Hourly"
            options="$options\n$daily_text"
            [[ "$DAILY_ENABLED" == true ]] && options="$options\n󰮆  Keep Last $DAILY_KEEP Daily"
            options="$options\n$weekly_text"
            [[ "$WEEKLY_ENABLED" == true ]] && options="$options\nudb83udcff  Keep Last $WEEKLY_KEEP Weekly"
            options="$options\n$monthly_text"
            [[ "$MONTHLY_ENABLED" == true ]] && options="$options\n󰮆  Keep Last $MONTHLY_KEEP Monthly"
            options="$options\n󰈆  Exit"
        fi
        
        # Add snapshots if destination exists
        if [[ -n "$DESTINATION" && -d "$DESTINATION" ]]; then
            local snapshots=$(ls -1t "$DESTINATION"/ 2>/dev/null | xargs -r -n1 basename | sed $'s/.*/\e[36m&\e[0m/')
            [[ -n "$snapshots" ]] && options="$options\n$snapshots"
        fi
        
        height=$(($(tput lines) - 1))
        choice=$(echo -e "$options" | fzf \
            --ansi \
            --layout=reverse \
            --prompt="  > " \
            --height=$height)
        
        [[ -z "$choice" ]] && exit 0
        
        case "$choice" in
            *"Create Snapshot"*) createSnapshot "" "true" ;;
            *"Destination"*) selectDestination ;;
            *"Manage Excludes"*) manageExcludes ;;
            *"Hourly Backups"*) toggleHourly ;;
            *"Keep"*"Hourly"*) setHourlyKeep ;;
            *"Daily Backups"*) toggleDaily ;;
            *"Keep"*"Daily"*) setDailyKeep ;;
            *"Weekly Backups"*) toggleWeekly ;;
            *"Keep"*"Weekly"*) setWeeklyKeep ;;
            *"Monthly Backups"*) toggleMonthly ;;
            *"Keep"*"Monthly"*) setMonthlyKeep ;;
            *"Exit"*) exit 0 ;;
            *-*) snapshotMenu "$choice" ;;
        esac
    done
}

OPEN_TERMINAL=false
BACKUP_MODE=false
BACKUP_NAME=""

while getopts "tbn:h" opt; do
    case $opt in
        t) OPEN_TERMINAL=true ;;
        b) BACKUP_MODE=true ;;
        n) BACKUP_NAME="$OPTARG" ;;
        h) showHelp; exit 0 ;;
        \?) echo "Invalid option. Use -h for help."; exit 1 ;;
    esac
done

if [[ "$BACKUP_MODE" == true ]]; then
    loadConfig
    createSnapshot "$BACKUP_NAME" "false"
    exit 0
fi

if [[ "$OPEN_TERMINAL" == true ]]; then
    openTerminal
    exit 0
fi

displayMenu