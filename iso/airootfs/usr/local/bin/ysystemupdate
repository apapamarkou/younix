#!/bin/bash

# __   __    _   _ _   _ ___  __
# \ \ / /__ | | | | \ | (_) \/ /
#  \ V / _ \| | | |  \| | |\  / 
#   | | (_) | |_| | |\  | |/  \ 
#   |_|\___/ \___/|_| \_|_/_/\_\
#
# Lisence GPL3
# Homepage: https://github.com/apapamarkou/younix
# Author: Andrianos Papamarkou
# Email: papamarkoua@gmail.com

#
# YoUNiX System Update
#

SCRIPT_NAME=$(basename "$0")
TITLE="System Update"
CACHE_FILE="/tmp/younix-updates.cache"
CACHE_TTL=1200


showHelp() {
    echo "$DISTRO_NAME $TITLE"
    echo "Usage: $SCRIPT_NAME [OPTIONS]"
    echo "Options:"
    echo "  -t           Open in terminal"
    echo "  -m           Show icon for waybar (updates available or not)"
    echo "  -h           Show this help"
}

openTerminal() {
    local args=""
    [ "$MUTE_NOTIFY" = true ] && args="$args -n"
    [ "$MUTE_ECHO" = true ] && args="$args -v"
    nohup flock -n $LOCK_DIR/$SCRIPT_NAME.lock terminal --columns=50 --lines=15 --title="$FLOATING_PREFIX $TITLE" $SCRIPT_NAME $args > /dev/null 2>&1 &
}

REPO_UPDATES=0
AUR_UPDATES=0
FLATPAK_UPDATES=0
SNAP_UPDATES=0

loadCache() {
    if [ -f "$CACHE_FILE" ] && [ $(($(date +%s) - $(stat -c %Y "$CACHE_FILE" 2>/dev/null || echo 0))) -lt $CACHE_TTL ]; then
        source "$CACHE_FILE"
        return 0
    fi
    return 1
}

saveCache() {
    cat > "$CACHE_FILE" << EOF
REPO_UPDATES=$REPO_UPDATES
AUR_UPDATES=$AUR_UPDATES
FLATPAK_UPDATES=$FLATPAK_UPDATES
SNAP_UPDATES=$SNAP_UPDATES
EOF
}

#Check is there are any repo updates and show the number of packages
checkRepos() {
    if ! command -v checkupdates &> /dev/null; then
        echo "Install pacman-contrib"
        REPO_UPDATES=0
        return
    fi

    REPO_UPDATES=$(checkupdates 2>/dev/null | wc -l)

    if [ "$REPO_UPDATES" -eq 0 ]; then
        echo "No updates available"
    else
        echo "Update $REPO_UPDATES Arch Repository packages"
    fi
}

checkAUR() {
    if ! command -v yay &> /dev/null; then
        echo "Install Arch User Repository support"
        return
    fi
    AUR_UPDATES=$(yay -Qua 2>/dev/null | wc -l)
    if [ $AUR_UPDATES -eq 0 ]; then
        echo "No AUR updates available"
    else
        echo "Update $AUR_UPDATES Arch User Repository packages"
    fi
}

checkFlatpak() {
    # if flatpak is not installed
    if ! command -v flatpak &> /dev/null; then
        echo "Install flatpak support"
        return
    fi
    FLATPAK_UPDATES=$(flatpak remote-ls --updates | wc -l)
    if [ $FLATPAK_UPDATES -eq 0 ]; then
        echo "No Flatpak updates available"
    else
        echo "Update $FLATPAK_UPDATES flatpak packages"
    fi
}

checkSnap() {
    # if snap is not installed
    if ! command -v snap &> /dev/null; then
        echo "Install Snap support"
        return
    fi
    SNAP_UPDATES=$(snap refresh --list | wc -l)
    if [ $SNAP_UPDATES -eq 0 ]; then
        echo "No Snap updates available"
    else
        echo "Update $SNAP_UPDATES snap packages"
    fi
}   

runInTerminal() {
    terminal --columns=120 --lines=25 --title="$FLOATING_PREFIX $TITLE" ysystemupdate-worker $1
}

displayMenu(){
    while true; do
        # Check all sources and show progress
        yprint --color=green "Checking Arch repositories"
        repo_text=$(checkRepos)
        echo $repo_text
        echo
        yprint --color=green "Checking AUR"
        aur_text=$(checkAUR)
        echo $aur_text
        echo
        yprint --color=green "Checking Flatpak"
        flatpak_text=$(checkFlatpak)
        echo $flatpak_text
        echo
        yprint --color=green "Checking Snap"
        snap_text=$(checkSnap)
        echo $snap_text
        sleep 5
        
        # Build options array A-F
        OPTION_A="A) Update All"
        OPTION_B="B) $repo_text"
        OPTION_C="C) $aur_text"
        OPTION_D="D) $flatpak_text"
        OPTION_E="E) $snap_text"
        OPTION_F="$EXIT_TEXT"

        options=("$OPTION_A" "$OPTION_B" "$OPTION_C" "$OPTION_D" "$OPTION_E" "$OPTION_F")
        height=$(($(tput lines) - 1))
        yprint -c --color=yellow "$DISTRO_NAME $TITLE"
        choice=$(printf "%s\n" "${options[@]}" | fzf --layout=reverse --prompt="  Select > " --height=$height)
        [ -z "$choice" ] && break
        
        case "$choice" in
            *"Update All"*) runInTerminal updateAll ;;
            *"Arch Repository"*) runInTerminal updateRepos ;;
            *"Arch User Repository"*) runInTerminal updateAUR ;;
            *"Install Arch User"*) runInTerminal InstallYay ;;
            *"flatpak packages"*) runInTerminal updateFlatpak ;;
            *"Install flatpak"*) runInTerminal installFlatpak ;;
            *"snap packages"*) runInTerminal updateSnap ;;
            *"Install Snap"*) runInTerminal installSnap ;;
            *"$EXIT_TEXT"*) break ;;
        esac
    done
}

OPEN_TERMINAL=false
SET_STATE=""
MONITOR_MODE=false
EXIT_TEXT="󰈆  Exit"

while getopts "ethnvms:" opt; do
    case $opt in
        e) EXIT_TEXT="󰌍  Back" ;;
        t) OPEN_TERMINAL=true ;;
        h) showHelp; exit 0 ;;
        n) MUTE_NOTIFY=true ;;
        v) MUTE_ECHO=true ;;
        m) MONITOR_MODE=true ;;
        s) SET_STATE="$OPTARG" ;;
        \?) echo "Invalid option. Use -h for help."; exit 1 ;;
    esac
done

if [ -n "$SET_STATE" ]; then
    case "$SET_STATE" in
        all) runInTerminal updateAll ;;
        repo) runInTerminal updateRepos ;;
        aur) runInTerminal updateAUR ;;
        flatpak) runInTerminal updateFlatpak ;;
        snap) runInTerminal updateSnap ;;
        *) echo "Invalid state. Use 'all', 'repo', 'aur', 'flatpak' or 'snap'."; exit 1 ;;
    esac
    exit 0
fi

if [ "$MONITOR_MODE" = true ]; then
    if ! loadCache; then
        checkRepos > /dev/null
        checkAUR > /dev/null
        checkFlatpak > /dev/null
        checkSnap > /dev/null
        saveCache
    fi
    
    total=$((REPO_UPDATES + AUR_UPDATES + FLATPAK_UPDATES + SNAP_UPDATES))

    if [ "$total" -gt 0 ]; then
        echo "{\"text\":\" $total\",\"tooltip\":\"\n\n    left click: update manager \n\n    right click: software manager \n\n Repo.....: $REPO_UPDATES \n\n AUR......: $AUR_UPDATES \n\n Flatpak..: $FLATPAK_UPDATES \n\n Snap.....: $SNAP_UPDATES \n\n\"}"
    else
        echo "{\"text\":\"\",\"tooltip\":\"System up to date\"}"
    fi
    exit 0
fi

if [ "$OPEN_TERMINAL" = true ]; then
    openTerminal
    exit 0
fi

displayMenu
