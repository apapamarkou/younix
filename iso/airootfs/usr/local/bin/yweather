#!/bin/bash

# __   __    _   _ _   _ ___  __
# \ \ / /__ | | | | \ | (_) \/ /
#  \ V / _ \| | | |  \| | |\  / 
#   | | (_) | |_| | |\  | |/  \ 
#   |_|\___/ \___/|_| \_|_/_/\_\
#
# Lisence GPL3
# Homepage: https://github.com/apapamarkou/younix
# Author: Andrianos Papamarkou
# Email: papamarkoua@gmail.com

#
# YoUNiX Weather Viewer
#

SCRIPT_NAME=$(basename "$0")
TITLE="Weather Viewer"
CITIES_FILE="$HOME/.config/yweather/cities.conf"
VIEW_OPTIONS_FILE="$HOME/.config/yweather/view_options.conf"
CACHE_FILE="/tmp/younix-weather.cache"
CACHE_TTL=10000

showHelp() {
    echo "$DISTRO_NAME $TITLE"
    echo "Usage: $SCRIPT_NAME [OPTIONS]"
    echo "Options:"
    echo "  -t           Open in terminal"
    echo "  -m           Mini view for polybar"
    echo "  -h           Show this help"
}

openTerminal() {
    nohup flock -n $LOCK_DIR/$SCRIPT_NAME.lock terminal --columns=160 --lines=40 --title="$FLOATING_PREFIX $TITLE" $SCRIPT_NAME
}

# Get default city from web or timezone
get_default_city() {
    # Try to get city from IP geolocation
    city=$(curl -s "http://ipinfo.io/city" 2>/dev/null)
    
    # If that fails, try timezone
    if [[ -z "$city" ]]; then
        city=$(timedatectl show --property=Timezone --value | cut -d'/' -f2)
    fi
    
    echo "$city"
}

# Initialize cities file
init_cities() {
    mkdir -p "$(dirname "$CITIES_FILE")"
    if [[ ! -f "$CITIES_FILE" ]]; then
        default_city=$(get_default_city)
        echo "$default_city" > "$CITIES_FILE"
    fi
}

# Add city
add_city() {
    read -p "Enter city name: " city
    [[ -n "$city" ]] && echo "$city" >> "$CITIES_FILE"
}

# Remove city
remove_city() {
    [[ ! -f "$CITIES_FILE" ]] && return
    city=$(cat "$CITIES_FILE" | fzf --prompt="Remove city: " --reverse)
    [[ -n "$city" ]] && sed -i "/^$city$/d" "$CITIES_FILE"
}

# Set city as default (move to first position)
set_default_city() {
    local city="$1"
    [[ ! -f "$CITIES_FILE" ]] && return
    
    # Remove city from current position and add to top
    sed -i "/^$city$/d" "$CITIES_FILE"
    sed -i "1i$city" "$CITIES_FILE"
}

# Check cache validity
load_cache() {
    if [[ -f "$CACHE_FILE" ]] && [[ $(($(date +%s) - $(stat -c %Y "$CACHE_FILE" 2>/dev/null || echo 0))) -lt $CACHE_TTL ]]; then
        cat "$CACHE_FILE"
        return 0
    fi
    return 1
}

# Save to cache
save_cache() {
    echo "$1" > "$CACHE_FILE"
}

# Mini view for polybar
mini_view() {
    init_cities
    [[ ! -f "$CITIES_FILE" ]] && exit 1
    
    # Try cache first
    if cached_data=$(load_cache); then
        echo "$cached_data"
        return
    fi
    
    default_city=$(head -n1 "$CITIES_FILE")
    weather_data=$(curl -s "wttr.in/$default_city?format=%c+%t" 2>/dev/null || echo "N/A")
    
    # Save to cache
    save_cache "$weather_data"
    echo "$weather_data"
}

# Viewer options
viewer_options() {
    options=("?0" "?1" "?2" "?3" "?A" "?F" "?n" "?q" "?Q" "?T")
    descriptions=("Current weather" "Today + 1 day" "Today + 2 days" "Today + 3 days" "Ignore User-Agent" "No follow redirects" "Narrow version" "Quiet version" "Super quiet" "No terminal sequences")
    
    tmpfile=$(mktemp)
    for i in "${!options[@]}"; do
        echo "${options[$i]} - ${descriptions[$i]}" >> "$tmpfile"
    done
    
    choice=$(cat "$tmpfile" | fzf --prompt="View option: " --reverse)
    rm -f "$tmpfile"
    
    if [[ -n "$choice" ]]; then
        option=$(echo "$choice" | cut -d' ' -f1)
        echo "$option" > "$VIEW_OPTIONS_FILE"
    fi
}

# Get current view option
get_view_option() {
    [[ -f "$VIEW_OPTIONS_FILE" ]] && cat "$VIEW_OPTIONS_FILE" || echo "?0"
}

# Preview function
preview_city() {
    case "$1" in
        "Add City") echo "Add a new city to your weather list" ;;
        "Remove City") echo "Remove a city from your weather list" ;;
        "Viewer Options") echo "Change weather display format" ;;
        *) 
            view_opt=$(get_view_option)
            curl -s "wttr.in/$1$view_opt" 2>/dev/null || echo "Weather data unavailable" 
            ;;
    esac
}

# Main menu
display_menu() {
    init_cities
    
    CYAN=$'\e[36m'
    RESET=$'\e[0m'

    while true; do
        tmpfile=$(mktemp)
        
        # Add cities first
        [[ -f "$CITIES_FILE" ]] && \
            sed "s/^/$CYAN/" "$CITIES_FILE" | sed "s/$/$RESET/" >> "$tmpfile"
        
        # Then add menu options
        echo "Add City" >> "$tmpfile"
        echo "Remove City" >> "$tmpfile"
        echo "Viewer Options" >> "$tmpfile"
        echo "Exit" >> "$tmpfile"

        height=$(($(tput lines) - 1))
        yprint -c --color=yellow "$DISTRO_NAME $TITLE"
        
        choice=$(cat "$tmpfile" | fzf --prompt="ï€‚  > " \
            --reverse --cycle --select-1 --exit-0 \
            --ansi \
            --preview 'bash -c "get_view_option() { [[ -f \"$HOME/.config/yweather/view_options.conf\" ]] && cat \"$HOME/.config/yweather/view_options.conf\" || echo \"?0\"; }; preview_city() { case \"\$1\" in \"Add City\") echo \"Add a new city to your weather list\" ;; \"Remove City\") echo \"Remove a city from your weather list\" ;; \"Viewer Options\") echo \"Change weather display format\" ;; \"Exit\") echo \"Exit the weather viewer\" ;; *) view_opt=\$(get_view_option); curl -s \"wttr.in/\$1\$view_opt\" 2>/dev/null || echo \"Weather data unavailable\" ;; esac }; preview_city {}"' \
            --preview-window=right:125 \
            --height=$height)
        
        rm -f "$tmpfile"
        [[ -z "$choice" ]] && break
        
        case "$choice" in
            "Add City") add_city ;;
            "Remove City") remove_city ;;
            "Viewer Options") viewer_options ;;
            "Exit") break ;;
            *) 
                # Set as default city and show weather
                set_default_city "$choice"
                view_opt=$(get_view_option)
                curl -s "wttr.in/$choice$view_opt" 
                ;;
        esac
    done
}

OPEN_TERMINAL=false
MINI_VIEW=false

while getopts "thm" opt; do
    case $opt in
        t) OPEN_TERMINAL=true ;;
        m) MINI_VIEW=true ;;
        h) showHelp; exit 0 ;;
        \?) echo "Invalid option. Use -h for help."; exit 1 ;;
    esac
done

if [ "$MINI_VIEW" = true ]; then
    mini_view
    exit 0
fi

if [ "$OPEN_TERMINAL" = true ]; then
    openTerminal
    exit 0
fi

display_menu